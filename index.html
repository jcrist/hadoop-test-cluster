
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>hadoop-test-cluster &#8212; hadoop-test-cluster 0.1.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="CLI Docs" href="cli.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="hadoop-test-cluster">
<h1>hadoop-test-cluster<a class="headerlink" href="#hadoop-test-cluster" title="Permalink to this headline">¶</a></h1>
<p>This package provides a docker setup and command-line tool for setting up and
managing several realistic <a class="reference external" href="http://hadoop.apache.org/">Hadoop</a> clusters. These can be useful for demo
purposes, but their main intended use is development and <em>testing</em>. The Hadoop
documentation is pretty emphatic about the <a class="reference external" href="https://hadoop.apache.org/docs/stable/hadoop-yarn/hadoop-yarn-site/YarnApplicationSecurity.html#Important">need for testing</a>:</p>
<blockquote>
<div><p><em>If you don’t test your YARN application in a secure Hadoop cluster, it
won’t work.</em></p>
</div></blockquote>
<p>Hadoop’s security model is notoriously tricky to get correct. So hard, one of
the main contributors wrote <a class="reference external" href="https://steveloughran.gitbooks.io/kerberos_and_hadoop/">an online book</a> comparing its difficulties to
<a class="reference external" href="https://en.wikipedia.org/wiki/H._P._Lovecraft">Lovecraftian Horrors</a>. The clusters provided here have settings selected to
hit potential issues in Hadoop and YARN applications so you can fix your code
early rather than in production. If your code runs on these clusters, it
should (hopefully) run on any cluster.</p>
<p><strong>Demo</strong></p>
<div align="center">
  <script src="https://asciinema.org/a/241014.js" id="asciicast-241014" async data-speed="3"></script>
</div><p><strong>Highlights</strong></p>
<ul class="simple">
<li><p>Easy to use <a class="reference external" href="cli.html">command-line tool</a></p></li>
<li><p>Supports both Hadoop 2 (<a class="reference external" href="https://www.cloudera.com/documentation/enterprise/5-16-x/topics/cdh_intro.html">CDH 5</a>) and Hadoop 3 (<a class="reference external" href="https://www.cloudera.com/documentation/enterprise/6/6.2/topics/cdh_intro.html">CDH 6</a>)</p></li>
<li><p>Supports both <a class="reference external" href="https://web.mit.edu/kerberos/">Kerberos</a> and Simple authentication modes</p></li>
<li><p>Comes with common development and testing dependencies pre-installed
(<a class="reference external" href="https://docs.conda.io/en/latest/miniconda.html">miniconda</a>, <a class="reference external" href="https://maven.apache.org/">maven</a>, <a class="reference external" href="https://git-scm.com/">git</a>, …)</p></li>
<li><p>Designed to minimize resource usage - runs fine both on laptops and on
common CI servers such as <a class="reference external" href="travis.html">Travis CI</a></p></li>
<li><p>Configured with a set of options designed to expose bugs in Hadoop
applications. If your code runs on these clusters, it should (hopefully) run
anywhere.</p></li>
</ul>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#installation" id="id1">Installation</a></p></li>
<li><p><a class="reference internal" href="#overview" id="id2">Overview</a></p>
<ul>
<li><p><a class="reference internal" href="#startup-a-cluster" id="id3">Startup a Cluster</a></p></li>
<li><p><a class="reference internal" href="#login-to-a-cluster" id="id4">Login to a Cluster</a></p></li>
<li><p><a class="reference internal" href="#execute-a-command-on-a-cluster" id="id5">Execute a Command on a Cluster</a></p></li>
<li><p><a class="reference internal" href="#shutdown-a-cluster" id="id6">Shutdown a Cluster</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#cluster-details" id="id7">Cluster Details</a></p>
<ul>
<li><p><a class="reference internal" href="#layout" id="id8">Layout</a></p></li>
<li><p><a class="reference internal" href="#installed-packages" id="id9">Installed Packages</a></p></li>
<li><p><a class="reference internal" href="#users" id="id10">Users</a></p></li>
<li><p><a class="reference internal" href="#ports" id="id11">Ports</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#authenticating-with-kerberos-from-outside-docker" id="id12">Authenticating with Kerberos from outside Docker</a></p></li>
</ul>
</div>
<div class="section" id="installation">
<h2><a class="toc-backref" href="#id1">Installation</a><a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">hadoop-test-cluster</span></code> is available on PyPI:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> pip install hadoop-test-cluster
</pre></div>
</div>
<p>You can also install from source on github:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> pip install git+https://github.com/jcrist/hadoop-test-cluster.git
</pre></div>
</div>
<p><a class="reference external" href="https://www.docker.com/">Docker</a> and <a class="reference external" href="https://docs.docker.com/compose/">Docker Compose</a> are required to already be installed on your
system - consult their docs for installation instructions.</p>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id2">Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The main entry point for this package is the <code class="docutils literal notranslate"><span class="pre">htcluster</span></code> command-line tool.
This tool can be used to start, stop, and interact with test Hadoop clusters.</p>
<div class="section" id="startup-a-cluster">
<h3><a class="toc-backref" href="#id3">Startup a Cluster</a><a class="headerlink" href="#startup-a-cluster" title="Permalink to this headline">¶</a></h3>
<p>To start a cluster, use the <code class="docutils literal notranslate"><span class="pre">htcluster</span> <span class="pre">startup</span></code> command. Two parameters are
used to describe which cluster to run:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--image</span></code>: which docker image to use</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--config</span></code>: which Hadoop configuration to run the cluster with</p></li>
</ul>
<p><strong>Images</strong></p>
<p>Currently supported images are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cdh5</span></code>: a <a class="reference external" href="https://www.cloudera.com/documentation/enterprise/5-16-x/topics/cdh_intro.html">CDH 5</a> installation of Hadoop 2.6 (image at <a class="reference external" href="https://cloud.docker.com/repository/docker/jcrist/hadoop-testing-cdh5">jcrist/hadoop-testing-cdh5</a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cdh6</span></code>: a <a class="reference external" href="https://www.cloudera.com/documentation/enterprise/6/6.2/topics/cdh_intro.html">CDH 6</a> installation of Hadoop 3.0 (image at <a class="reference external" href="https://cloud.docker.com/repository/docker/jcrist/hadoop-testing-cdh6">jcrist/hadoop-testing-cdh6</a>)</p></li>
</ul>
<p>To determine which version of Hadoop a cluster is running, see the
<code class="docutils literal notranslate"><span class="pre">HADOOP_TESTING_VERSION</span></code> environment variable (will be set to either <code class="docutils literal notranslate"><span class="pre">cdh5</span></code>
or <code class="docutils literal notranslate"><span class="pre">cdh6</span></code>).</p>
<p><strong>Configurations</strong></p>
<p>Currently two different configurations are supported:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">simple</span></code>: uses simple authentication (unix user permissions)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kerberos</span></code>: uses kerberos for authentication</p></li>
</ul>
<p>To determine which configuration a cluster is running, see the
<code class="docutils literal notranslate"><span class="pre">HADOOP_TESTING_CONFIG</span></code> environment variable (will be set to either
<code class="docutils literal notranslate"><span class="pre">simple</span></code> or <code class="docutils literal notranslate"><span class="pre">kerberos</span></code>).</p>
<p><strong>Examples</strong></p>
<p>Start a CDH 5 cluster with simple authentication:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> htcluster startup --image cdh5 --config simple
</pre></div>
</div>
<p>Start a CDH6 cluster with kerberos authentication:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> htcluster startup --image cdh6 --config kerberos
</pre></div>
</div>
<p>Start a cluster, mounting the current directory to ~/workdir:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> htcluster startup --image cdh5 --mount .:workdir
</pre></div>
</div>
</div>
<div class="section" id="login-to-a-cluster">
<h3><a class="toc-backref" href="#id4">Login to a Cluster</a><a class="headerlink" href="#login-to-a-cluster" title="Permalink to this headline">¶</a></h3>
<p>For interactive work, you can log in to a cluster using the <code class="docutils literal notranslate"><span class="pre">htcluster</span> <span class="pre">login</span></code>
command.</p>
<p><strong>Examples</strong></p>
<p>Login to the edge node as the default user:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> htcluster login
</pre></div>
</div>
<p>Login to the master node as root:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> htcluster login --user root --service master
</pre></div>
</div>
</div>
<div class="section" id="execute-a-command-on-a-cluster">
<h3><a class="toc-backref" href="#id5">Execute a Command on a Cluster</a><a class="headerlink" href="#execute-a-command-on-a-cluster" title="Permalink to this headline">¶</a></h3>
<p>Instead of logging in, you can also run a command on a cluster using the
<code class="docutils literal notranslate"><span class="pre">htcluster</span> <span class="pre">exec</span></code> command.</p>
<p><strong>Examples</strong></p>
<p>Run <code class="docutils literal notranslate"><span class="pre">py.test</span></code> on a cluster:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> htcluster <span class="nb">exec</span> -- py.test /path/to/my/tests
</pre></div>
</div>
<p>Follow the HDFS Namenode logs:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> htcluster <span class="nb">exec</span> --user root --service master <span class="se">\</span>
  -- tail -f /var/log/hadoop-hdfs/hadoop-hdfs-namenode.log
</pre></div>
</div>
</div>
<div class="section" id="shutdown-a-cluster">
<h3><a class="toc-backref" href="#id6">Shutdown a Cluster</a><a class="headerlink" href="#shutdown-a-cluster" title="Permalink to this headline">¶</a></h3>
<p>To shutdown a cluster, use the <code class="docutils literal notranslate"><span class="pre">htcluster</span> <span class="pre">shutdown</span></code> command.</p>
<p><strong>Example</strong></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> htcluster shutdown
</pre></div>
</div>
</div>
</div>
<div class="section" id="cluster-details">
<h2><a class="toc-backref" href="#id7">Cluster Details</a><a class="headerlink" href="#cluster-details" title="Permalink to this headline">¶</a></h2>
<p>Here we provide more details on what each cluster supports.</p>
<div class="section" id="layout">
<h3><a class="toc-backref" href="#id8">Layout</a><a class="headerlink" href="#layout" title="Permalink to this headline">¶</a></h3>
<p>Each cluster has three containers:</p>
<ul class="simple">
<li><p>One <code class="docutils literal notranslate"><span class="pre">master</span></code> node running the <code class="docutils literal notranslate"><span class="pre">hdfs-namenode</span></code> and
<code class="docutils literal notranslate"><span class="pre">yarn-resourcemanager</span></code>, as well as the kerberos daemons. Hostname is
<code class="docutils literal notranslate"><span class="pre">master.example.com</span></code>.</p></li>
<li><p>One <code class="docutils literal notranslate"><span class="pre">worker</span></code> node running the <code class="docutils literal notranslate"><span class="pre">hdfs-datanode</span></code> and <code class="docutils literal notranslate"><span class="pre">yarn-nodemanager</span></code>.
Hostname is <code class="docutils literal notranslate"><span class="pre">worker.example.com</span></code>.</p></li>
<li><p>One <code class="docutils literal notranslate"><span class="pre">edge</span></code> node for interacting with the cluster. Hostname is
<code class="docutils literal notranslate"><span class="pre">edge.example.com</span></code>.</p></li>
</ul>
</div>
<div class="section" id="installed-packages">
<h3><a class="toc-backref" href="#id9">Installed Packages</a><a class="headerlink" href="#installed-packages" title="Permalink to this headline">¶</a></h3>
<p>All clusters provide the following packages:</p>
<ul class="simple">
<li><p>HDFS</p></li>
<li><p>YARN</p></li>
<li><p><a class="reference external" href="https://web.mit.edu/kerberos/">Kerberos</a></p></li>
<li><p><a class="reference external" href="https://docs.conda.io/en/latest/miniconda.html">Miniconda</a></p></li>
<li><p><a class="reference external" href="https://maven.apache.org/">Maven</a></p></li>
<li><p><a class="reference external" href="https://git-scm.com/">Git</a></p></li>
</ul>
<p>Additional packages can be installed at runtime with <code class="docutils literal notranslate"><span class="pre">yum</span></code>, <code class="docutils literal notranslate"><span class="pre">conda</span></code>, or
<code class="docutils literal notranslate"><span class="pre">pip</span></code>.</p>
</div>
<div class="section" id="users">
<h3><a class="toc-backref" href="#id10">Users</a><a class="headerlink" href="#users" title="Permalink to this headline">¶</a></h3>
<p>One default user account has also been created for testing purposes:</p>
<ul class="simple">
<li><p>Login: <code class="docutils literal notranslate"><span class="pre">testuser</span></code></p></li>
<li><p>Password: <code class="docutils literal notranslate"><span class="pre">testpass</span></code></p></li>
</ul>
<p>When using kerberos, a keytab for this user has been put at
<code class="docutils literal notranslate"><span class="pre">/home/testuser/testuser.keytab</span></code>, so you can kinit easily like <code class="docutils literal notranslate"><span class="pre">kinit</span> <span class="pre">-kt</span>
<span class="pre">/home/testuser/testuser.keytab</span> <span class="pre">testuser</span></code>.</p>
<p>An admin kerberos principal has also been created for use with <code class="docutils literal notranslate"><span class="pre">kadmin</span></code>:</p>
<ul class="simple">
<li><p>Login: <code class="docutils literal notranslate"><span class="pre">root/admin</span></code></p></li>
<li><p>Password: <code class="docutils literal notranslate"><span class="pre">adminpass</span></code></p></li>
</ul>
</div>
<div class="section" id="ports">
<h3><a class="toc-backref" href="#id11">Ports</a><a class="headerlink" href="#ports" title="Permalink to this headline">¶</a></h3>
<p>The following ports are exposed:</p>
<p><strong>Master Node</strong></p>
<ul class="simple">
<li><p>NameNode RPC: 9000</p></li>
<li><p>NameNode Webui: 50070</p></li>
<li><p>ResourceManager Webui: 8088</p></li>
<li><p>Kerberos KDC: 88</p></li>
<li><p>Kerberos Kadmin: 749</p></li>
</ul>
<p><strong>Worker Node</strong>
- DataNode Webui: 50075
- NodeManager Webui: 8042</p>
<p><strong>Edge Node</strong>
- User Defined: 8888
- User Defined: 8786</p>
<p>The full address for accessing these is dependent on the IP address of your
docker-machine driver, which can be found at:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> docker-machine inspect --format <span class="o">{{</span>.Driver.IPAddress<span class="o">}})</span>
</pre></div>
</div>
<p>If you frequently want access to the WebUI’s, it’s recommended to add the
following lines to your <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;docker-machine-ip&gt;    edge.example.com
&lt;docker-machine-ip&gt;    master.example.com
&lt;docker-machine-ip&gt;    worker.example.com
</pre></div>
</div>
</div>
</div>
<div class="section" id="authenticating-with-kerberos-from-outside-docker">
<h2><a class="toc-backref" href="#id12">Authenticating with Kerberos from outside Docker</a><a class="headerlink" href="#authenticating-with-kerberos-from-outside-docker" title="Permalink to this headline">¶</a></h2>
<p>With the kerberos configuration, the Web UI’s are secured by kerberos, and so
won’t be accessible from your browser unless you configure things properly.
This is doable, but takes a few steps:</p>
<ol class="arabic">
<li><p>Kerberos/SPNEGO requires that the requested url matches the hosts domain.
The easiest way to do this is to modify your <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> and add a line for
<code class="docutils literal notranslate"><span class="pre">master.example.com</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> Add a line to /etc/hosts pointing master.example.com to your docker-machine
<span class="gp">#</span> driver ip address.
<span class="gp">#</span> Note that you probably need to run this <span class="nb">command</span> as a super user.
<span class="gp">$</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="k">$(</span>docker-machine inspect --format <span class="o">{{</span>.Driver.IPAddress<span class="o">}}</span><span class="k">)</span><span class="s2">  master.example.com&quot;</span> &gt;&gt; /etc/hosts
</pre></div>
</div>
</li>
<li><p>You must have <code class="docutils literal notranslate"><span class="pre">kinit</span></code> installed locally. You may already have it, otherwise
it’s available through most package managers.</p></li>
<li><p>You need to tell kerberos where the <code class="docutils literal notranslate"><span class="pre">krb5.conf</span></code> is for this domain. This is
done with an environment variable. To make this easy, <code class="docutils literal notranslate"><span class="pre">htcluster</span></code> has a
command to do this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">eval</span> <span class="k">$(</span>htcluster kerbenv<span class="k">)</span>
</pre></div>
</div>
</li>
<li><p>At this point you should be able to kinit as testuser:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> kinit testuser@EXAMPLE.COM
</pre></div>
</div>
</li>
<li><p>To access kerberos secured pages in your browser you’ll need to do a bit of
(simple) configuration. See <a class="reference external" href="https://www.cloudera.com/documentation/enterprise/5-9-x/topics/cdh_sg_browser_access_kerberos_protected_url.html">this documentation from Cloudera</a> for
information on what’s needed for your browser.</p></li>
<li><p>Since environment variables are only available for processes started in the
environment, you have three options here:</p>
<ul>
<li><p>Restart your browser from the shell in which you added the environment
variables</p></li>
<li><p>Manually get a ticket for the <code class="docutils literal notranslate"><span class="pre">HTTP/master.example.com</span></code> principal. Note
that this will delete your other tickets, but works fine if you just want
to see the webpage</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> kinit -S HTTP/master.example.com testuser
</pre></div>
</div>
</li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">curl</span></code> to authenticate the first time, at which point you’ll already
have the proper tickets in your cache, and the browser authentication will
just work. Note that your version of curl must support the GSS-API.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> curl -V  <span class="c1"># Check your version of curl supports GSS-API</span>
<span class="go">curl 7.59.0 (x86_64-apple-darwin17.2.0) libcurl/7.59.0 SecureTransport zlib/1.2.11</span>
<span class="go">Release-Date: 2018-03-14</span>
<span class="go">Protocols: dict file ftp ftps gopher http https imap imaps ldap ldaps pop3 pop3s rtsp smb smbs smtp smtps telnet tftp</span>
<span class="go">Features: AsynchDNS IPv6 Largefile GSS-API Kerberos SPNEGO NTLM NTLM_WB SSL libz UnixSockets</span>

<span class="gp">$</span> curl --negotiate -u : http://master.example.com:50070  <span class="c1"># get a HTTP ticket for master.example.com</span>
</pre></div>
</div>
</li>
</ul>
<p>After doing one of these, you should be able to access any of the pages from
your browser.</p>
</li>
</ol>
<div class="toctree-wrapper compound">
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="#">hadoop-test-cluster</a></h1>



<p class="blurb">A docker setup for testing software on realistic Hadoop Clusters</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=jcrist&repo=hadoop-test-cluster&type=watch&count=False&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cli.html">CLI Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="travis.html">Usage on Travis CI</a></li>
</ul>

<h3>Need help?</h3>

<p>
  Open an issue in the <a href="https://github.com/jcrist/hadoop-test-cluster/issues">issue tracker</a>.
</p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Jim Crist.
      
      |
      <a href="_sources/index.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>